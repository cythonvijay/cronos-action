name: 'CRONOS Code Guard'
description: 'Static analysis for Python code changes with risk assessment'
author: 'cythonvijay'
branding:
  icon: 'shield'
  color: 'blue'

inputs:
  api_url:
    description: 'CRONOS API endpoint URL'
    required: true
  mode:
    description: 'Analysis mode: STRICT, BOUNDARY, or CONTRACT'
    required: false
    default: 'STRICT'

runs:
  using: 'composite'
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        if ! command -v jq &>/dev/null; then
          sudo apt-get update -qq && sudo apt-get install -y jq
        fi

    - name: Run CRONOS Analysis
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        MODE: ${{ inputs.mode }}
      run: |
        set -euo pipefail

        API_URL="${API_URL%/}"
        REPORT_DIR="cronos-reports"
        mkdir -p "$REPORT_DIR"

        echo "====================================="
        echo "CRONOS Analysis - Mode: $MODE"
        echo "API: $API_URL"
        echo "====================================="

        if [ -z "$API_URL" ]; then
          echo "ERROR: api_url is empty. Check CRONOS_API_URL secret."
          echo "## CRONOS: api_url secret is missing" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        set +e
        curl -sf --max-time 15 "$API_URL/" > /dev/null 2>&1
        HEALTH_EXIT=$?
        set -e
        if [ "$HEALTH_EXIT" -ne 0 ]; then
          echo "ERROR: API unreachable (curl exit=$HEALTH_EXIT)"
          echo "## CRONOS: API Unreachable at $API_URL" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi
        echo "API OK"

        FILES=""
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.py$' || true)
        else
          FILES=$(git ls-files '*.py' || true)
        fi

        if [ -z "$FILES" ]; then
          echo "No Python files changed."
          echo "## CRONOS: No Python changes detected" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        echo "Files: $FILES"

        FAIL_COUNT=0
        WARN_COUNT=0
        PASS_COUNT=0
        TOTAL=0

        # ---------------------------------------------------------------
        # Inline parser â€” base64-encoded Python script.
        # Reads the /analyze_ci JSON response and:
        #   1. Prints a formatted console summary
        #   2. Appends a markdown table to $GITHUB_STEP_SUMMARY
        #
        # v6 fields now surfaced (all optional / gracefully absent):
        #   quality_score, security_score, overall_score
        #   behavior_changed, behavior_summary
        #   execution_prediction { possible_outputs, confidence }
        #   report_id
        #
        # Exit codes:  0 = PASS   2 = WARN   1 = FAIL
        # ---------------------------------------------------------------
        PARSER=$(mktemp).py
        echo "aW1wb3J0IGpzb24sc3lzLHNodXRpbApyZXNfZixmaWxlbmFtZSxyZXBvcnRfZixzdW1tYXJ5X2Y9c3lzLmFyZ3ZbMV0sc3lzLmFyZ3ZbMl0sc3lzLmFyZ3ZbM10sc3lzLmFyZ3ZbNF0Kd2l0aCBvcGVuKHJlc19mKSBhcyBmOgogICAgZD1qc29uLmxvYWQoZikKc2h1dGlsLmNvcHkocmVzX2YscmVwb3J0X2YpCnN0YXR1cz1kLmdldCgic3RhdHVzIiwiRkFJTCIpO3Jpc2s9ZC5nZXQoInJpc2siLDEwMCk7ZmluZGluZ3Nfbj1kLmdldCgiZmluZGluZ3NfY291bnQiLDApCm1vZGU9ZC5nZXQoIm1vZGUiLCJVTktOT1dOIik7dGltZXN0YW1wPWQuZ2V0KCJ0aW1lc3RhbXAiLCJOL0EiKTtzdW1tYXJ5PWQuZ2V0KCJzdW1tYXJ5IixbXSkKcD1kLmdldCgicGFzcyIsRmFsc2UpO3c9ZC5nZXQoIndhcm4iLEZhbHNlKTtmYWlsPWQuZ2V0KCJmYWlsIixUcnVlKQpxdWFsaXR5PWQuZ2V0KCJxdWFsaXR5X3Njb3JlIiwiTi9BIik7c2VjdXJpdHk9ZC5nZXQoInNlY3VyaXR5X3Njb3JlIiwiTi9BIik7b3ZlcmFsbD1kLmdldCgib3ZlcmFsbF9zY29yZSIsIk4vQSIpCmJlaGF2aW9yX2NoYW5nZWQ9ZC5nZXQoImJlaGF2aW9yX2NoYW5nZWQiLEZhbHNlKTtiZWhhdmlvcl9zdW1tYXJ5PWQuZ2V0KCJiZWhhdmlvcl9zdW1tYXJ5IiwiIikKZXhlY19wcmVkPWQuZ2V0KCJleGVjdXRpb25fcHJlZGljdGlvbiIse30pO3JlcG9ydF9pZD1kLmdldCgicmVwb3J0X2lkIiwiTi9BIikKbWV0YT1kLmdldCgibWV0YWRhdGEiLHt9KTtvbGRfaGFzaD1tZXRhLmdldCgib2xkX2hhc2giLCIiKTtuZXdfaGFzaD1tZXRhLmdldCgibmV3X2hhc2giLCIiKQphc3RfY2g9bWV0YS5nZXQoImFzdF9jaGFuZ2VkIixOb25lKTtzZW1hbnRpYz1tZXRhLmdldCgic2VtYW50aWNfZGlmZiIsTm9uZSkKY2F0ZWdvcmllcz1tZXRhLmdldCgiY2F0ZWdvcmllc19hbmFseXplZCIsMCk7cmlza19iZD1tZXRhLmdldCgicmlza19icmVha2Rvd24iLHt9KQpwcmludCgiLSIqNTEpCnByaW50KGYiICBGaWxlICAgICAgICA6IHtmaWxlbmFtZX0iKQpwcmludChmIiAgU3RhdHVzICAgICAgOiB7c3RhdHVzfSIpCnByaW50KGYiICBSaXNrIFNjb3JlICA6IHtyaXNrfS8xMDAiKQpwcmludChmIiAgTW9kZSAgICAgICAgOiB7bW9kZX0iKQpwcmludChmIiAgRmluZGluZ3MgICAgOiB7ZmluZGluZ3Nfbn0iKQpwcmludChmIiAgVGltZXN0YW1wICAgOiB7dGltZXN0YW1wfSIpCmlmIHF1YWxpdHkhPSJOL0EiOnByaW50KGYiICBRdWFsaXR5ICAgICA6IHtxdWFsaXR5fS8xMDAiKQppZiBzZWN1cml0eSE9Ik4vQSI6cHJpbnQoZiIgIFNlY3VyaXR5ICAgIDoge3NlY3VyaXR5fS8xMDAiKQppZiBvdmVyYWxsIT0iTi9BIjpwcmludChmIiAgT3ZlcmFsbCAgICAgOiB7b3ZlcmFsbH0vMTAwIikKaWYgYmVoYXZpb3JfY2hhbmdlZDpwcmludChmIiAgQmVoYXZpb3IgXHUwMzk0ICA6IFlFUyAtIHtiZWhhdmlvcl9zdW1tYXJ5fSIpCmlmIGFzdF9jaCBpcyBub3QgTm9uZTpwcmludChmIiAgQVNUIENoYW5nZWQgOiB7YXN0X2NofSIpCmlmIHNlbWFudGljIGlzIG5vdCBOb25lOnByaW50KGYiICBTZW1hbnRpYyAgICA6IHtzZW1hbnRpY30iKQppZiBvbGRfaGFzaDpwcmludChmIiAgT2xkIEhhc2ggICAgOiB7b2xkX2hhc2hbOjE2XX0uLi4iKQppZiBuZXdfaGFzaDpwcmludChmIiAgTmV3IEhhc2ggICAgOiB7bmV3X2hhc2hbOjE2XX0uLi4iKQppZiBjYXRlZ29yaWVzOnByaW50KGYiICBDYXRlZ29yaWVzICA6IHtjYXRlZ29yaWVzfSBhbmFseXplZCIpCmlmIGV4ZWNfcHJlZCBhbmQgZXhlY19wcmVkLmdldCgicG9zc2libGVfb3V0cHV0cyIpOgogICAgb3V0cz1leGVjX3ByZWRbInBvc3NpYmxlX291dHB1dHMiXVs6M10KICAgIGNvbmY9ZXhlY19wcmVkLmdldCgiY29uZmlkZW5jZSIsMCkKICAgIHByaW50KGYiICBFeGVjIFByZWQgICA6IHtvdXRzfSAoY29uZjp7Y29uZn0pIikKaWYgc3VtbWFyeToKICAgIHByaW50KCIgIEZpbmRpbmdzIERldGFpbDoiKQogICAgZm9yIGkscyBpbiBlbnVtZXJhdGUoc3VtbWFyeSwxKTpwcmludChmIiAgICB7aX0uIHtzfSIpCmlmIHJpc2tfYmQ6CiAgICBhY3RpdmU9e2s6diBmb3Igayx2IGluIHJpc2tfYmQuaXRlbXMoKSBpZiB2PjB9CiAgICBpZiBhY3RpdmU6CiAgICAgICAgcHJpbnQoIiAgUmlzayBCcmVha2Rvd246IikKICAgICAgICBmb3IgY2F0LHZhbCBpbiBhY3RpdmUuaXRlbXMoKTpwcmludChmIiAgICAtIHtjYXQucmVwbGFjZShjaHIoOTUpLGNocigzMikpLnRpdGxlKCl9OiB7dmFsfS8xMDAiKQpwcmludCgiLSIqNTEpCmVtb2ppPSJcVTAwMDFmNTM0IiBpZiBmYWlsIGVsc2UoIlxVMDAwMWY3ZTEiIGlmIHcgZWxzZSJcVTAwMDFmN2UyIikKdmVyZGljdD0iRkFJTCIgaWYgZmFpbCBlbHNlKCJXQVJOIiBpZiB3IGVsc2UiUEFTUyIpCndpdGggb3BlbihzdW1tYXJ5X2YsImEiKSBhcyBzZjoKICAgIHNmLndyaXRlKGYiIyMjIHtlbW9qaX0ge3ZlcmRpY3R9IC0gYHtmaWxlbmFtZX1gXG5cbiIpCiAgICBzZi53cml0ZSgifCBGaWVsZCB8IFZhbHVlIHxcbnwtLS18LS0tfFxuIikKICAgIHNmLndyaXRlKGYifCBTdGF0dXMgfCAqKntzdGF0dXN9KiogfFxuIikKICAgIHNmLndyaXRlKGYifCBSaXNrIFNjb3JlIHwgKip7cmlza30vMTAwKiogfFxuIikKICAgIHNmLndyaXRlKGYifCBNb2RlIHwge21vZGV9IHxcbiIpCiAgICBzZi53cml0ZShmInwgRmluZGluZ3MgfCB7ZmluZGluZ3Nfbn0gfFxuIikKICAgIGlmIHF1YWxpdHkhPSJOL0EiOnNmLndyaXRlKGYifCBRdWFsaXR5IFNjb3JlIHwgKip7cXVhbGl0eX0vMTAwKiogfFxuIikKICAgIGlmIHNlY3VyaXR5IT0iTi9BIjpzZi53cml0ZShmInwgU2VjdXJpdHkgU2NvcmUgfCAqKntzZWN1cml0eX0vMTAwKiogfFxuIikKICAgIGlmIG92ZXJhbGwhPSJOL0EiOnNmLndyaXRlKGYifCBPdmVyYWxsIFNjb3JlIHwgKip7b3ZlcmFsbH0vMTAwKiogfFxuIikKICAgIHNmLndyaXRlKGYifCBBU1QgQ2hhbmdlZCB8IHthc3RfY2h9IHxcbiIpCiAgICBzZi53cml0ZShmInwgU2VtYW50aWMgRGlmZiB8IHtzZW1hbnRpY30gfFxuIikKICAgIHNmLndyaXRlKGYifCBUaW1lc3RhbXAgfCB7dGltZXN0YW1wfSB8XG4iKQogICAgaWYgb2xkX2hhc2g6c2Yud3JpdGUoZiJ8IE9sZCBIYXNoIHwgYHtvbGRfaGFzaFs6MTZdfS4uLmAgfFxuIikKICAgIGlmIG5ld19oYXNoOnNmLndyaXRlKGYifCBOZXcgSGFzaCB8IGB7bmV3X2hhc2hbOjE2XX0uLi5gIHxcbiIpCiAgICBpZiBiZWhhdmlvcl9jaGFuZ2VkOnNmLndyaXRlKGYifCBCZWhhdmlvciBDaGFuZ2UgfCB7YmVoYXZpb3Jfc3VtbWFyeX0gfFxuIikKICAgIGlmIGV4ZWNfcHJlZCBhbmQgZXhlY19wcmVkLmdldCgicG9zc2libGVfb3V0cHV0cyIpOgogICAgICAgIG91dHNfc3RyPSIsICIuam9pbihzdHIobykgZm9yIG8gaW4gZXhlY19wcmVkWyJwb3NzaWJsZV9vdXRwdXRzIl1bOjNdKQogICAgICAgIGNvbmY9ZXhlY19wcmVkLmdldCgiY29uZmlkZW5jZSIsMCkKICAgICAgICBzZi53cml0ZShmInwgRXhlYyBQcmVkaWN0aW9uIHwge291dHNfc3RyfSAoY29uZjoge2NvbmZ9KSB8XG4iKQogICAgaWYgcmVwb3J0X2lkIT0iTi9BIjpzZi53cml0ZShmInwgUmVwb3J0IElEIHwgYHtyZXBvcnRfaWR9YCB8XG4iKQogICAgc2Yud3JpdGUoIlxuIikKICAgIGlmIHN1bW1hcnk6CiAgICAgICAgc2Yud3JpdGUoIiMjIyMgRmluZGluZ3MgRGV0YWlsXG5cbiIpCiAgICAgICAgZm9yIGkscyBpbiBlbnVtZXJhdGUoc3VtbWFyeSwxKTpzZi53cml0ZShmIntpfS4ge3N9XG4iKQogICAgICAgIHNmLndyaXRlKCJcbiIpCiAgICBpZiByaXNrX2JkOgogICAgICAgIGFjdGl2ZT17azp2IGZvciBrLHYgaW4gcmlza19iZC5pdGVtcygpIGlmIHY+MH0KICAgICAgICBpZiBhY3RpdmU6CiAgICAgICAgICAgIHNmLndyaXRlKCIjIyMjIFJpc2sgQnJlYWtkb3duIGJ5IENhdGVnb3J5XG5cbiIpCiAgICAgICAgICAgIHNmLndyaXRlKCJ8IENhdGVnb3J5IHwgUmlzayB8XG58LS0tfC0tLXxcbiIpCiAgICAgICAgICAgIGZvciBjYXQsdmFsIGluIGFjdGl2ZS5pdGVtcygpOnNmLndyaXRlKGYifCB7Y2F0LnJlcGxhY2UoY2hyKDk1KSxjaHIoMzIpKS50aXRsZSgpfSB8IHt2YWx9LzEwMCB8XG4iKQogICAgICAgICAgICBzZi53cml0ZSgiXG4iKQpzeXMuZXhpdCgwIGlmIHN0YXR1cz09IlBBU1MiIGVsc2UoMiBpZiBzdGF0dXM9PSJXQVJOIiBlbHNlIDEpKQo=" | base64 -d > "$PARSER"

        for file in $FILES; do
          [ ! -f "$file" ] && continue
          TOTAL=$((TOTAL + 1))
          echo ""
          echo "=========================================="
          echo "Analyzing: $file"
          echo "=========================================="

          OLD_F=$(mktemp); NEW_F=$(mktemp); PAY_F=$(mktemp)
          RES_F=$(mktemp); SCR_F=$(mktemp).py

          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            git show HEAD~1:"$file" > "$OLD_F" 2>/dev/null || true
          fi
          cp "$file" "$NEW_F"

          printf 'import json\n'                                          > "$SCR_F"
          printf 'o=open("%s").read()\n'                    "$OLD_F"    >> "$SCR_F"
          printf 'n=open("%s").read()\n'                    "$NEW_F"    >> "$SCR_F"
          printf 'p={"old_code":o,"new_code":n,"mode":"%s"}\n' "$MODE" >> "$SCR_F"
          printf 'open("%s","w").write(json.dumps(p))\n'   "$PAY_F"    >> "$SCR_F"
          python3 "$SCR_F"
          rm -f "$OLD_F" "$NEW_F" "$SCR_F"

          set +e
          HTTP=$(curl -s -w "%{http_code}" -o "$RES_F" \
            -X POST "$API_URL/analyze_ci" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --max-time 60 \
            -d "@$PAY_F")
          CE=$?
          set -e
          rm -f "$PAY_F"

          echo "HTTP=$HTTP curl_exit=$CE"
          REPORT="$REPORT_DIR/$(echo "$file" | tr '/' '_').json"

          if [ "$CE" -ne 0 ]; then
            printf '{"status":"FAIL","risk":100,"findings_count":1,"summary":["curl error %s"]}\n' "$CE" > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi
          if [ "$HTTP" != "200" ]; then
            printf '{"status":"FAIL","risk":100,"findings_count":1,"summary":["HTTP error %s"]}\n' "$HTTP" > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          SZ=$(wc -c < "$RES_F" 2>/dev/null || echo 0)
          if [ "$SZ" -eq 0 ]; then
            echo '{"status":"FAIL","risk":100,"findings_count":1,"summary":["empty response"]}' > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          if ! python3 -c "import json,sys; json.load(open('$RES_F'))" 2>/dev/null; then
            echo '{"status":"FAIL","risk":100,"findings_count":1,"summary":["invalid JSON"]}' > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          set +e
          python3 "$PARSER" "$RES_F" "$file" "$REPORT" "$GITHUB_STEP_SUMMARY"
          PY_EXIT=$?
          set -e
          rm -f "$RES_F"

          if   [ "$PY_EXIT" -eq 0 ]; then PASS_COUNT=$((PASS_COUNT+1))
          elif [ "$PY_EXIT" -eq 2 ]; then WARN_COUNT=$((WARN_COUNT+1))
          else                             FAIL_COUNT=$((FAIL_COUNT+1))
          fi
        done

        rm -f "$PARSER"

        echo ""
        echo "====================================="
        echo "Total=$TOTAL Pass=$PASS_COUNT Warn=$WARN_COUNT Fail=$FAIL_COUNT"
        echo "====================================="

        {
          echo "---"
          echo "## CRONOS Final Summary"
          echo ""
          echo "| | Count |"
          echo "|---|---|"
          echo "| Passed | $PASS_COUNT |"
          echo "| Warned | $WARN_COUNT |"
          echo "| Failed | $FAIL_COUNT |"
          echo "| Total  | $TOTAL |"
        } >> "$GITHUB_STEP_SUMMARY"

        if [ "$FAIL_COUNT" -gt 0 ]; then
          echo "BUILD BLOCKED - $FAIL_COUNT file(s) failed"
          exit 1
        fi
        echo "BUILD APPROVED"
        exit 0
