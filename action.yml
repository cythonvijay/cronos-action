name: 'CRONOS Code Guard'
description: 'Enterprise-grade Python intelligence: Risk Â· Quality Â· Security Â· Severity Â· PR Comments Â· Annotations Â· AI Explanation'
author: 'cythonvijay'
branding:
  icon: 'shield'
  color: 'blue'

inputs:
  api_url:
    description: 'CRONOS API endpoint URL'
    required: true
  mode:
    description: 'Analysis mode: STRICT | BOUNDARY | CONTRACT'
    required: false
    default: 'STRICT'
  github_token:
    description: 'GitHub token for PR comments and Check Run annotations'
    required: false
    default: ''
  pr_number:
    description: 'Pull request number (auto-detected if not provided)'
    required: false
    default: ''
  post_pr_comment:
    description: 'Post intelligence report as PR comment (true/false)'
    required: false
    default: 'true'
  create_annotations:
    description: 'Create GitHub Check Run with inline annotations (true/false)'
    required: false
    default: 'true'
  repo:
    description: 'Repository slug (owner/repo). Defaults to GITHUB_REPOSITORY.'
    required: false
    default: ''
  fail_on_severity:
    description: 'Minimum severity level to fail the build (CRITICAL|HIGH|MEDIUM|LOW|SAFE)'
    required: false
    default: 'HIGH'

runs:
  using: 'composite'
  steps:

    # â”€â”€ Step 1: Install system dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Install dependencies
      shell: bash
      run: |
        if ! command -v jq &>/dev/null; then
          sudo apt-get update -qq && sudo apt-get install -y jq
        fi

    # â”€â”€ Step 2: Full intelligence analysis + PR comment + annotations â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Run CRONOS Enterprise Intelligence Analysis
      shell: bash
      env:
        API_URL:            ${{ inputs.api_url }}
        MODE:               ${{ inputs.mode }}
        GITHUB_TOKEN_INPUT: ${{ inputs.github_token }}
        PR_NUMBER_INPUT:    ${{ inputs.pr_number }}
        POST_PR_COMMENT:    ${{ inputs.post_pr_comment }}
        CREATE_ANNOTATIONS: ${{ inputs.create_annotations }}
        REPO_INPUT:         ${{ inputs.repo }}
        FAIL_ON_SEVERITY:   ${{ inputs.fail_on_severity }}
      run: |
        set -euo pipefail

        API_URL="${API_URL%/}"
        REPORT_DIR="cronos-reports"
        mkdir -p "$REPORT_DIR"

        # â”€â”€ Resolve token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        GH_TOKEN="${GITHUB_TOKEN_INPUT:-${GITHUB_TOKEN:-}}"

        # â”€â”€ Resolve repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        REPO="${REPO_INPUT:-${GITHUB_REPOSITORY:-}}"
        OWNER="${REPO%%/*}"
        REPO_NAME="${REPO##*/}"
        SHA="${GITHUB_SHA:-}"
        REF="${GITHUB_REF:-}"

        # â”€â”€ Resolve PR number â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        PR_NUMBER="${PR_NUMBER_INPUT:-}"
        if [ -z "$PR_NUMBER" ] && [ -f "${GITHUB_EVENT_PATH:-/dev/null}" ]; then
          PR_NUMBER=$(python3 -c "
import json,sys
try:
    d=json.load(open('${GITHUB_EVENT_PATH}'))
    pr=d.get('pull_request',{}).get('number') or d.get('number')
    print(pr or '')
except:
    print('')
" 2>/dev/null || true)
        fi

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   CRONOS v8 â€” Enterprise Intelligence Mode           â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘  Mode              : $MODE"
        echo "â•‘  API               : $API_URL"
        echo "â•‘  Repo              : $REPO"
        echo "â•‘  SHA               : ${SHA:0:12}..."
        echo "â•‘  PR Number         : ${PR_NUMBER:-none}"
        echo "â•‘  Post PR Comment   : $POST_PR_COMMENT"
        echo "â•‘  Create Annotations: $CREATE_ANNOTATIONS"
        echo "â•‘  Fail on Severity  : $FAIL_ON_SEVERITY"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        if [ -z "$API_URL" ]; then
          echo "ERROR: api_url is empty."
          echo "## âŒ CRONOS: api_url secret is missing" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        # â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        set +e
        curl -sf --max-time 15 "$API_URL/" > /dev/null 2>&1
        HEALTH=$?
        set -e
        if [ "$HEALTH" -ne 0 ]; then
          echo "ERROR: API unreachable (curl=$HEALTH)"
          echo "## âŒ CRONOS: API unreachable at $API_URL" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi
        echo "âœ… API reachable"

        # â”€â”€ Detect changed Python files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        FILES=""
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.py$' || true)
        else
          FILES=$(git ls-files '*.py' || true)
        fi

        if [ -z "$FILES" ]; then
          echo "No Python files changed."
          echo "## â„¹ï¸ CRONOS: No Python changes detected" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        echo "Python files to analyze: $FILES"

        FAIL_COUNT=0; WARN_COUNT=0; PASS_COUNT=0; TOTAL=0
        LAST_REPORT_ID=""   # tracks the most recent report_id for PR comment
        SEVERITY_ORDER="SAFE LOW MEDIUM HIGH CRITICAL"

        # â”€â”€ Severity threshold check helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        sev_rank() {
          case "$1" in
            SAFE)     echo 0 ;;
            LOW)      echo 1 ;;
            MEDIUM)   echo 2 ;;
            HIGH)     echo 3 ;;
            CRITICAL) echo 4 ;;
            *)        echo 2 ;;
          esac
        }
        FAIL_RANK=$(sev_rank "$FAIL_ON_SEVERITY")

        # â”€â”€ Per-file analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        for file in $FILES; do
          [ ! -f "$file" ] && continue
          TOTAL=$((TOTAL + 1))
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Analyzing: $file"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          OLD_F=$(mktemp); NEW_F=$(mktemp); PAY_F=$(mktemp); RES_F=$(mktemp); SCR_F=$(mktemp).py

          # Get old version
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            git show HEAD~1:"$file" > "$OLD_F" 2>/dev/null || true
          fi
          cp "$file" "$NEW_F"

          # Build JSON payload (includes repo, file, sha for DB + PR)
          cat > "$SCR_F" << 'PYEOF'
import json, sys
old_f, new_f, pay_f, mode, repo, file_, sha = sys.argv[1:]
o = open(old_f).read()
n = open(new_f).read()
p = {"old_code": o, "new_code": n, "mode": mode, "repo": repo, "file": file_}
open(pay_f, "w").write(json.dumps(p))
PYEOF
          python3 "$SCR_F" "$OLD_F" "$NEW_F" "$PAY_F" "$MODE" "$REPO" "$file" "$SHA"
          rm -f "$OLD_F" "$NEW_F" "$SCR_F"

          # Call /analyze_full
          set +e
          HTTP=$(curl -s -w "%{http_code}" -o "$RES_F" \
            -X POST "$API_URL/analyze_full" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --max-time 120 \
            -d "@$PAY_F")
          CE=$?
          set -e
          rm -f "$PAY_F"

          echo "  HTTP=$HTTP curl=$CE"
          REPORT="$REPORT_DIR/$(echo "$file" | tr '/' '_').json"

          # Handle curl / HTTP errors
          if [ "$CE" -ne 0 ] || [ "$HTTP" != "200" ]; then
            printf '{"status":"FAIL","risk_score":100,"severity":"CRITICAL","findings_count":1,"summary":["API error HTTP=%s curl=%s"],"pass":false,"warn":false,"fail":true}\n' "$HTTP" "$CE" > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          SZ=$(wc -c < "$RES_F" 2>/dev/null || echo 0)
          if [ "$SZ" -eq 0 ] || ! python3 -c "import json,sys; json.load(open('$RES_F'))" 2>/dev/null; then
            echo '{"status":"FAIL","risk_score":100,"severity":"CRITICAL","findings_count":1,"summary":["Invalid response"],"pass":false,"warn":false,"fail":true}' > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          cp "$RES_F" "$REPORT"

          # â”€â”€ Extract fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          STATUS=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('status','FAIL'))")
          SEVERITY=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('severity','UNKNOWN'))")
          RISK=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('risk_score',d.get('risk',0)))")
          SECURITY=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('security_score','N/A'))")
          OVERALL=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('overall_score','N/A'))")
          QUALITY=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('quality_score','N/A'))")
          REPORT_ID=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('report_id','N/A'))")
          TECH_EXP=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('technical_explanation','')[:200])")
          HUMAN_EXP=$(python3 -c "import json; d=json.load(open('$REPORT')); print(d.get('human_explanation','')[:200])")
          BEH_CHANGED=$(python3 -c "import json; d=json.load(open('$REPORT')); b=d.get('behavior',{}); print('YES' if b.get('changed') else 'NO')")
          SEV_RANK=$(sev_rank "$SEVERITY")
          # Track latest report ID so the dedicated PR comment step can use it
          if [ "$REPORT_ID" != "N/A" ] && [ -n "$REPORT_ID" ]; then
            LAST_REPORT_ID="$REPORT_ID"
          fi

          echo "  Status   : $STATUS"
          echo "  Severity : $SEVERITY"
          echo "  Risk     : $RISK/100"
          echo "  Security : $SECURITY/100"
          echo "  Overall  : $OVERALL/100"
          echo "  Behavior : Changed=$BEH_CHANGED"

          # â”€â”€ Create Check Run annotations (Feature 2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ "$CREATE_ANNOTATIONS" = "true" ] && [ -n "$GH_TOKEN" ] && [ -n "$SHA" ] && [ -n "$OWNER" ]; then
            echo "  ðŸ” Creating Check Run annotations..."
            set +e
            curl -sf -X POST "$API_URL/github/check_run" \
              -H "Content-Type: application/json" \
              -d "{\"report_id\":\"$REPORT_ID\",\"sha\":\"$SHA\",\"owner\":\"$OWNER\",\"repo\":\"$REPO_NAME\",\"filename\":\"$file\",\"github_token\":\"$GH_TOKEN\"}" \
              > /dev/null 2>&1
            set -e
            echo "  âœ… Check Run created"
          fi

          # â”€â”€ Write GitHub Step Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          SEV_EMOJI=""
          case "$SEVERITY" in
            CRITICAL) SEV_EMOJI="ðŸ”´" ;;
            HIGH)     SEV_EMOJI="ðŸŸ " ;;
            MEDIUM)   SEV_EMOJI="ðŸŸ¡" ;;
            LOW)      SEV_EMOJI="ðŸ”µ" ;;
            SAFE)     SEV_EMOJI="ðŸŸ¢" ;;
            *)        SEV_EMOJI="âšª" ;;
          esac

          {
            echo "### ${SEV_EMOJI} ${SEVERITY} â€” \`${file}\`"
            echo ""
            echo "| Metric | Score |"
            echo "|---|---|"
            echo "| Risk Score | **${RISK}/100** |"
            echo "| Security Score | **${SECURITY}/100** |"
            echo "| Quality Score | **${QUALITY}/100** |"
            echo "| Overall Score | **${OVERALL}/100** |"
            echo "| Status | **${STATUS}** |"
            echo "| Severity | **${SEVERITY}** |"
            echo "| Behavior Changed | **${BEH_CHANGED}** |"
            echo ""
            if [ -n "$TECH_EXP" ]; then
              echo "#### ðŸ§  Technical Explanation"
              echo "> ${TECH_EXP}"
              echo ""
            fi
            if [ -n "$HUMAN_EXP" ]; then
              echo "#### ðŸ’¬ Human Explanation"
              echo "> ${HUMAN_EXP}"
              echo ""
            fi
            if [ -n "$REPORT_ID" ] && [ "$REPORT_ID" != "N/A" ]; then
              echo "#### ðŸ“¥ Report Downloads"
              echo "- [ðŸ“„ JSON Report](${API_URL}/report/json/${REPORT_ID})"
              echo "- [ðŸ“Š PDF Report](${API_URL}/report/pdf/${REPORT_ID})"
              echo ""
            fi
            echo "---"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          rm -f "$RES_F"

          # â”€â”€ Verdict â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ "$SEV_RANK" -ge "$FAIL_RANK" ]; then
            FAIL_COUNT=$((FAIL_COUNT+1))
          elif [ "$STATUS" = "WARN" ]; then
            WARN_COUNT=$((WARN_COUNT+1))
          else
            PASS_COUNT=$((PASS_COUNT+1))
          fi
        done

        # â”€â”€ Post CRONOS PR Comment (Feature 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Runs once after all files are analysed, using the last report ID.
        # Explicit dedicated step â€” never buried or silent.
        if [ "$POST_PR_COMMENT" = "true" ] \
           && [ -n "$GH_TOKEN" ] \
           && [ -n "$PR_NUMBER" ] \
           && [ -n "$OWNER" ] \
           && [ -n "$LAST_REPORT_ID" ]; then
          echo ""
          echo "ðŸ“ Posting CRONOS PR comment (report=$LAST_REPORT_ID)..."
          set +e
          PR_RESP=$(curl -s -w "\n%{http_code}" -X POST "$API_URL/github/pr_comment" \
            -H "Content-Type: application/json" \
            -d "{
              \"report_id\":    \"$LAST_REPORT_ID\",
              \"pr_number\":    $PR_NUMBER,
              \"owner\":        \"$OWNER\",
              \"repo\":         \"$REPO_NAME\",
              \"github_token\": \"$GH_TOKEN\"
            }")
          PR_HTTP=$(echo "$PR_RESP" | tail -1)
          set -e
          if [ "$PR_HTTP" = "200" ]; then
            echo "âœ… PR comment posted successfully"
          else
            echo "âš ï¸  PR comment returned HTTP $PR_HTTP (non-fatal)"
          fi
        fi

        # â”€â”€ Final summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  CRONOS v8 â€” Final Gate Results"
        echo "  Total=$TOTAL  Pass=$PASS_COUNT  Warn=$WARN_COUNT  Fail=$FAIL_COUNT"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        {
          echo "---"
          echo "## ðŸ CRONOS v8 â€” Final Summary"
          echo ""
          echo "| Result | Count |"
          echo "|---|---|"
          echo "| ðŸŸ¢ Passed | $PASS_COUNT |"
          echo "| ðŸŸ¡ Warned | $WARN_COUNT |"
          echo "| ðŸ”´ Failed | $FAIL_COUNT |"
          echo "| Total     | $TOTAL |"
          echo ""
          echo "_Fail threshold: **${FAIL_ON_SEVERITY}** severity or above_"
        } >> "$GITHUB_STEP_SUMMARY"

        if [ "$FAIL_COUNT" -gt 0 ]; then
          echo "ðŸ”´ BUILD BLOCKED â€” $FAIL_COUNT file(s) exceeded severity threshold ($FAIL_ON_SEVERITY)"
          exit 1
        fi
        echo "âœ… BUILD APPROVED â€” all files passed CRONOS intelligence gate"
        exit 0
