name: 'CRONOS Code Guard'
description: 'Enterprise-grade Python intelligence analysis â€” Risk, Quality, Security, Execution Prediction, AI Explanation'
author: 'cythonvijay'
branding:
  icon: 'shield'
  color: 'blue'

inputs:
  api_url:
    description: 'CRONOS API endpoint URL'
    required: true
  mode:
    description: 'Analysis mode: STRICT, BOUNDARY, or CONTRACT'
    required: false
    default: 'STRICT'

runs:
  using: 'composite'
  steps:
    - name: Install dependencies
      shell: bash
      run: |
        if ! command -v jq &>/dev/null; then
          sudo apt-get update -qq && sudo apt-get install -y jq
        fi

    - name: Run CRONOS Full Intelligence Analysis
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        MODE: ${{ inputs.mode }}
      run: |
        set -euo pipefail

        API_URL="${API_URL%/}"
        REPORT_DIR="cronos-reports"
        mkdir -p "$REPORT_DIR"

        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   CRONOS v7 â€” Full Intelligence Mode     â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘  Mode : $MODE"
        echo "â•‘  API  : $API_URL"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        if [ -z "$API_URL" ]; then
          echo "ERROR: api_url is empty. Check CRONOS_API_URL secret."
          echo "## CRONOS: api_url secret is missing" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        # â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        set +e
        curl -sf --max-time 15 "$API_URL/" > /dev/null 2>&1
        HEALTH_EXIT=$?
        set -e
        if [ "$HEALTH_EXIT" -ne 0 ]; then
          echo "ERROR: API unreachable (curl exit=$HEALTH_EXIT)"
          echo "## CRONOS: API Unreachable at $API_URL" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi
        echo "âœ… API reachable"

        # â”€â”€ Detect changed Python files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        FILES=""
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.py$' || true)
        else
          FILES=$(git ls-files '*.py' || true)
        fi

        if [ -z "$FILES" ]; then
          echo "No Python files changed."
          echo "## CRONOS: No Python changes detected" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        echo "Files to analyse: $FILES"

        FAIL_COUNT=0
        WARN_COUNT=0
        PASS_COUNT=0
        TOTAL=0

        # â”€â”€ Inline parser (base64-encoded Python) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Reads the /analyze_full JSON response and:
        #   1. Prints a full console intelligence report
        #   2. Appends GitHub Step Summary markdown
        #
        # Displays all v7 fields:
        #   Risk / Quality / Security / Overall scores
        #   Old hash / New hash / Semantic hash
        #   Execution prediction (outputs, state changes, exceptions)
        #   Technical explanation / Human explanation
        #   Risk reasoning / Behavioral impact
        #   Download links (JSON + PDF)
        #
        # argv[5] = API_URL (used to build download links)
        # Exit codes: 0 = PASS   2 = WARN   1 = FAIL
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        PARSER=$(mktemp).py
        echo "aW1wb3J0IGpzb24sc3lzLHNodXRpbCxvcwpyZXNfZixmaWxlbmFtZSxyZXBvcnRfZixzdW1tYXJ5X2Y9c3lzLmFyZ3ZbMV0sc3lzLmFyZ3ZbMl0sc3lzLmFyZ3ZbM10sc3lzLmFyZ3ZbNF0KYXBpX3VybD1zeXMuYXJndls1XSBpZiBsZW4oc3lzLmFyZ3YpPjUgZWxzZSAiIgp3aXRoIG9wZW4ocmVzX2YpIGFzIGY6CiAgICBkPWpzb24ubG9hZChmKQpzaHV0aWwuY29weShyZXNfZixyZXBvcnRfZikKCiMg4pSA4pSAIENvcmUgZmllbGRzIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgApzdGF0dXM9ZC5nZXQoInN0YXR1cyIsIkZBSUwiKTtyaXNrPWQuZ2V0KCJyaXNrIixkLmdldCgicmlza19zY29yZSIsMTAwKSkKZmluZGluZ3Nfbj1kLmdldCgiZmluZGluZ3NfY291bnQiLDApO21vZGU9ZC5nZXQoIm1vZGUiLCJVTktOT1dOIikKdGltZXN0YW1wPWQuZ2V0KCJ0aW1lc3RhbXAiLCJOL0EiKTtzdW1tYXJ5PWQuZ2V0KCJzdW1tYXJ5IixbXSkKcD1kLmdldCgicGFzcyIsRmFsc2UpO3c9ZC5nZXQoIndhcm4iLEZhbHNlKTtmYWlsPWQuZ2V0KCJmYWlsIixUcnVlKQoKIyDilIDilIAgdjcgc2NvcmVzIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgApxdWFsaXR5PWQuZ2V0KCJxdWFsaXR5X3Njb3JlIiwiTi9BIik7c2VjdXJpdHk9ZC5nZXQoInNlY3VyaXR5X3Njb3JlIiwiTi9BIikKb3ZlcmFsbD1kLmdldCgib3ZlcmFsbF9zY29yZSIsIk4vQSIpO2JlaGF2aW9yX2NoYW5nZWQ9ZC5nZXQoImJlaGF2aW9yX2NoYW5nZWQiLEZhbHNlKQpiZWhhdmlvcl9zdW1tYXJ5PWQuZ2V0KCJiZWhhdmlvcl9zdW1tYXJ5IiwiIikKYmVoPWQuZ2V0KCJiZWhhdmlvciIse30pCmlmIG5vdCBiZWhhdmlvcl9jaGFuZ2VkOmJlaGF2aW9yX2NoYW5nZWQ9YmVoLmdldCgiY2hhbmdlZCIsRmFsc2UpCmlmIG5vdCBiZWhhdmlvcl9zdW1tYXJ5OmJlaGF2aW9yX3N1bW1hcnk9YmVoLmdldCgic3VtbWFyeSIsIiIpCgojIOKUgOKUgCBIYXNoIHRyaWFkIOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgOKUgApvbGRfaGFzaD1kLmdldCgib2xkX2hhc2giLCIiKTtuZXdfaGFzaD1kLmdldCgibmV3X2hhc2giLCIiKTtzZW1hbnRpY19oYXNoPWQuZ2V0KCJzZW1hbnRpY19oYXNoIiwiIikKbWV0YT1kLmdldCgibWV0YWRhdGEiLHt9KQppZiBub3Qgb2xkX2hhc2g6b2xkX2hhc2g9bWV0YS5nZXQoIm9sZF9oYXNoIiwiIikKaWYgbm90IG5ld19oYXNoOm5ld19oYXNoPW1ldGEuZ2V0KCJuZXdfaGFzaCIsIiIpCmFzdF9jaD1tZXRhLmdldCgiYXN0X2NoYW5nZWQiLE5vbmUpO3NlbWFudGljPW1ldGEuZ2V0KCJzZW1hbnRpY19kaWZmIixOb25lKQpjYXRlZ29yaWVzPW1ldGEuZ2V0KCJjYXRlZ29yaWVzX2FuYWx5emVkIiwwKTtyaXNrX2JkPW1ldGEuZ2V0KCJyaXNrX2JyZWFrZG93biIse30pCgojIOKUgOKUgCBFeGVjdXRpb24gcHJlZGljdGlvbiDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKZXhlY19wcmVkPWQuZ2V0KCJleGVjdXRpb25fcHJlZGljdGlvbiIse30pCnBvc3NpYmxlX291dHB1dHM9ZXhlY19wcmVkLmdldCgicG9zc2libGVfb3V0cHV0cyIsW10pCnN0YXRlX2NoYW5nZXM9ZXhlY19wcmVkLmdldCgic3RhdGVfY2hhbmdlcyIsW10pCmV4Y2VwdGlvbnM9ZXhlY19wcmVkLmdldCgiZXhjZXB0aW9ucyIsW10pCmNvbmY9ZXhlY19wcmVkLmdldCgiY29uZmlkZW5jZSIsMCkKCiMg4pSA4pSAIEFJIGV4cGxhbmF0aW9ucyDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKdGVjaF9leHA9ZC5nZXQoInRlY2huaWNhbF9leHBsYW5hdGlvbiIsZC5nZXQoInNlbWFudGljX2V4cGxhbmF0aW9uIiwiIikpCmh1bWFuX2V4cD1kLmdldCgiaHVtYW5fZXhwbGFuYXRpb24iLCIiKQpyaXNrX3JlYXNvbj1kLmdldCgicmlza19yZWFzb25pbmciLCIiKQpiZWhhdl9pbXBhY3Q9ZC5nZXQoImJlaGF2aW9yYWxfaW1wYWN0IiwiIikKcmVwb3J0X2lkPWQuZ2V0KCJyZXBvcnRfaWQiLCJOL0EiKQphaV9wcm92aWRlcj1kLmdldCgiYWlfcHJvdmlkZXIiLCJOL0EiKQoKIyDilIDilIAgQ29uc29sZSBvdXRwdXQg4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSA4pSAClNFUD0i4pWQIio1NQpwcmludChTRVApCnByaW50KGYiICBDUk9OT1MgSW50ZWxsaWdlbmNlIFJlcG9ydCDigJQgdjciKQpwcmludChTRVApCnByaW50KGYiICBGaWxlICAgICAgICAgICA6IHtmaWxlbmFtZX0iKQpwcmludChmIiAgU3RhdHVzICAgICAgICAgOiB7c3RhdHVzfSIpCnByaW50KGYiICBNb2RlICAgICAgICAgICA6IHttb2RlfSIpCnByaW50KGYiICBUaW1lc3RhbXAgICAgICA6IHt0aW1lc3RhbXB9IikKcHJpbnQoKQpwcmludChmIiAgUmlzayBTY29yZSAgICAgOiB7cmlza30vMTAwIikKaWYgcXVhbGl0eSE9Ik4vQSI6cHJpbnQoZiIgIFF1YWxpdHkgU2NvcmUgIDoge3F1YWxpdHl9LzEwMCIpCmlmIHNlY3VyaXR5IT0iTi9BIjpwcmludChmIiAgU2VjdXJpdHkgU2NvcmUgOiB7c2VjdXJpdHl9LzEwMCIpCmlmIG92ZXJhbGwhPSJOL0EiOnByaW50KGYiICBPdmVyYWxsIFNjb3JlICA6IHtvdmVyYWxsfS8xMDAiKQpwcmludCgpCmlmIG9sZF9oYXNoOnByaW50KGYiICBPbGQgSGFzaCAgICAgICA6IHtvbGRfaGFzaFs6MjRdfS4uLiIpCmlmIG5ld19oYXNoOnByaW50KGYiICBOZXcgSGFzaCAgICAgICA6IHtuZXdfaGFzaFs6MjRdfS4uLiIpCmlmIHNlbWFudGljX2hhc2g6cHJpbnQoZiIgIFNlbWFudGljIEhhc2ggIDoge3NlbWFudGljX2hhc2hbOjI0XX0uLi4iKQppZiBhc3RfY2ggaXMgbm90IE5vbmU6cHJpbnQoZiIgIEFTVCBDaGFuZ2VkICAgIDoge2FzdF9jaH0iKQppZiBzZW1hbnRpYyBpcyBub3QgTm9uZTpwcmludChmIiAgU2VtYW50aWMgRGlmZiAgOiB7c2VtYW50aWN9IikKcHJpbnQoKQppZiBwb3NzaWJsZV9vdXRwdXRzIG9yIHN0YXRlX2NoYW5nZXMgb3IgZXhjZXB0aW9uczoKICAgIHByaW50KGYiICBFeGVjdXRpb24gUHJlZGljdGlvbiAoY29uZmlkZW5jZToge2NvbmZ9KToiKQogICAgZm9yIG8gaW4gcG9zc2libGVfb3V0cHV0c1s6NV06cHJpbnQoZiIgICAgb3V0cHV0ICDihpIge299IikKICAgIGZvciBzIGluIHN0YXRlX2NoYW5nZXNbOjRdOnByaW50KGYiICAgIHN0YXRlICAg4oaSIHtzfSIpCiAgICBmb3IgZSBpbiBleGNlcHRpb25zWzozXTpwcmludChmIiAgICByYWlzZXMgIOKGkiB7ZX0iKQogICAgcHJpbnQoKQppZiB0ZWNoX2V4cDoKICAgIHByaW50KGYiICBUZWNobmljYWwgRXhwbGFuYXRpb246IikKICAgIHdvcmRzPXRlY2hfZXhwLnNwbGl0KCkKICAgIGxpbmU9IiIKICAgIGZvciB3IGluIHdvcmRzOgogICAgICAgIGlmIGxlbihsaW5lKStsZW4odykrMT43MDpwcmludChmIiAgICB7bGluZX0iKTtsaW5lPXcKICAgICAgICBlbHNlOmxpbmU9KGxpbmUrIiAiK3cpLnN0cmlwKCkKICAgIGlmIGxpbmU6cHJpbnQoZiIgICAge2xpbmV9IikKICAgIHByaW50KCkKaWYgaHVtYW5fZXhwOgogICAgcHJpbnQoZiIgIEh1bWFuIEV4cGxhbmF0aW9uOiIpCiAgICB3b3Jkcz1odW1hbl9leHAuc3BsaXQoKQogICAgbGluZT0iIgogICAgZm9yIHcgaW4gd29yZHM6CiAgICAgICAgaWYgbGVuKGxpbmUpK2xlbih3KSsxPjcwOnByaW50KGYiICAgIHtsaW5lfSIpO2xpbmU9dwogICAgICAgIGVsc2U6bGluZT0obGluZSsiICIrdykuc3RyaXAoKQogICAgaWYgbGluZTpwcmludChmIiAgICB7bGluZX0iKQogICAgcHJpbnQoKQppZiByaXNrX3JlYXNvbjpwcmludChmIiAgUmlzayBSZWFzb25pbmcgOiB7cmlza19yZWFzb25bOjEyMF19IikKaWYgYmVoYXZfaW1wYWN0OnByaW50KGYiICBCZWhhdmlvciBJbXBhY3Q6IHtiZWhhdl9pbXBhY3RbOjEyMF19IikKaWYgYmVoYXZpb3JfY2hhbmdlZDpwcmludChmIiAgQmVoYXZpb3IgzpQgICAgIDogWUVTIOKAlCB7YmVoYXZpb3Jfc3VtbWFyeX0iKQpwcmludCgpCmlmIHN1bW1hcnk6CiAgICBwcmludCgiICBGaW5kaW5nczoiKQogICAgZm9yIGkscyBpbiBlbnVtZXJhdGUoc3VtbWFyeSwxKTpwcmludChmIiAgICB7aX0uIHtzfSIpCiAgICBwcmludCgpCmlmIHJpc2tfYmQ6CiAgICBhY3RpdmU9e2s6diBmb3Igayx2IGluIHJpc2tfYmQuaXRlbXMoKSBpZiB2PjB9CiAgICBpZiBhY3RpdmU6CiAgICAgICAgcHJpbnQoIiAgUmlzayBCcmVha2Rvd246IikKICAgICAgICBmb3IgY2F0LHZhbCBpbiBhY3RpdmUuaXRlbXMoKTpwcmludChmIiAgICAtIHtjYXQucmVwbGFjZShjaHIoOTUpLGNocigzMikpLnRpdGxlKCl9OiB7dmFsfS8xMDAiKQogICAgICAgIHByaW50KCkKaWYgcmVwb3J0X2lkIT0iTi9BIiBhbmQgYXBpX3VybDoKICAgIGJhc2U9YXBpX3VybC5yc3RyaXAoIi8iKQogICAgcHJpbnQoZiIgIERvd25sb2FkIFJlcG9ydHM6IikKICAgIHByaW50KGYiICAgIEpTT04gOiB7YmFzZX0vcmVwb3J0L2pzb24ve3JlcG9ydF9pZH0iKQogICAgcHJpbnQoZiIgICAgUERGICA6IHtiYXNlfS9yZXBvcnQvcGRmL3tyZXBvcnRfaWR9IikKICAgIHByaW50KGYiICAgIFN0b3JlOiB7YmFzZX0vcmVwb3J0L3N0b3JlL3tyZXBvcnRfaWR9IikKICAgIHByaW50KCkKcHJpbnQoU0VQKQoKIyDilIDilIAgR2l0SHViIFN0ZXAgU3VtbWFyeSDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIDilIAKZW1vamk9IlxVMDAwMWY1MzQiIGlmIGZhaWwgZWxzZSgiXFUwMDAxZjdlMSIgaWYgdyBlbHNlIlxVMDAwMWY3ZTIiKQp2ZXJkaWN0PSJGQUlMIiBpZiBmYWlsIGVsc2UoIldBUk4iIGlmIHcgZWxzZSJQQVNTIikKd2l0aCBvcGVuKHN1bW1hcnlfZiwiYSIpIGFzIHNmOgogICAgc2Yud3JpdGUoZiIjIyMge2Vtb2ppfSB7dmVyZGljdH0g4oCUIGB7ZmlsZW5hbWV9YFxuXG4iKQogICAgc2Yud3JpdGUoIiMjIyMg8J+TiiBTY29yZXNcblxuIikKICAgIHNmLndyaXRlKCJ8IE1ldHJpYyB8IFNjb3JlIHxcbnwtLS18LS0tfFxuIikKICAgIHNmLndyaXRlKGYifCBSaXNrIFNjb3JlIHwgKip7cmlza30vMTAwKiogfFxuIikKICAgIGlmIHF1YWxpdHkhPSJOL0EiOnNmLndyaXRlKGYifCBRdWFsaXR5IFNjb3JlIHwgKip7cXVhbGl0eX0vMTAwKiogfFxuIikKICAgIGlmIHNlY3VyaXR5IT0iTi9BIjpzZi53cml0ZShmInwgU2VjdXJpdHkgU2NvcmUgfCAqKntzZWN1cml0eX0vMTAwKiogfFxuIikKICAgIGlmIG92ZXJhbGwhPSJOL0EiOnNmLndyaXRlKGYifCBPdmVyYWxsIFNjb3JlIHwgKip7b3ZlcmFsbH0vMTAwKiogfFxuIikKICAgIHNmLndyaXRlKGYifCBTdGF0dXMgfCAqKntzdGF0dXN9KiogfFxuIikKICAgIHNmLndyaXRlKGYifCBNb2RlIHwge21vZGV9IHxcbiIpCiAgICBzZi53cml0ZShmInwgVGltZXN0YW1wIHwge3RpbWVzdGFtcH0gfFxuXG4iKQogICAgaWYgb2xkX2hhc2ggb3IgbmV3X2hhc2ggb3Igc2VtYW50aWNfaGFzaDoKICAgICAgICBzZi53cml0ZSgiIyMjIyDwn5SQIEludGVncml0eSBIYXNoZXNcblxuIikKICAgICAgICBzZi53cml0ZSgifCBIYXNoIHwgVmFsdWUgfFxufC0tLXwtLS18XG4iKQogICAgICAgIGlmIG9sZF9oYXNoOnNmLndyaXRlKGYifCBPbGQgSGFzaCB8IGB7b2xkX2hhc2hbOjMyXX0uLi5gIHxcbiIpCiAgICAgICAgaWYgbmV3X2hhc2g6c2Yud3JpdGUoZiJ8IE5ldyBIYXNoIHwgYHtuZXdfaGFzaFs6MzJdfS4uLmAgfFxuIikKICAgICAgICBpZiBzZW1hbnRpY19oYXNoOnNmLndyaXRlKGYifCBTZW1hbnRpYyBIYXNoIHwgYHtzZW1hbnRpY19oYXNoWzozMl19Li4uYCB8XG4iKQogICAgICAgIHNmLndyaXRlKCJcbiIpCiAgICBpZiBwb3NzaWJsZV9vdXRwdXRzIG9yIHN0YXRlX2NoYW5nZXMgb3IgZXhjZXB0aW9uczoKICAgICAgICBzZi53cml0ZSgiIyMjIyDimpnvuI8gRXhlY3V0aW9uIFByZWRpY3Rpb25cblxuIikKICAgICAgICBzZi53cml0ZShmIioqQ29uZmlkZW5jZToqKiB7Y29uZn1cblxuIikKICAgICAgICBpZiBwb3NzaWJsZV9vdXRwdXRzOgogICAgICAgICAgICBzZi53cml0ZSgiKipQb3NzaWJsZSBPdXRwdXRzOioqXG4iKQogICAgICAgICAgICBmb3IgbyBpbiBwb3NzaWJsZV9vdXRwdXRzWzo1XTpzZi53cml0ZShmIi0gYHtvfWBcbiIpCiAgICAgICAgICAgIHNmLndyaXRlKCJcbiIpCiAgICAgICAgaWYgc3RhdGVfY2hhbmdlczoKICAgICAgICAgICAgc2Yud3JpdGUoIioqU3RhdGUgQ2hhbmdlczoqKlxuIikKICAgICAgICAgICAgZm9yIHMgaW4gc3RhdGVfY2hhbmdlc1s6NF06c2Yud3JpdGUoZiItIGB7c31gXG4iKQogICAgICAgICAgICBzZi53cml0ZSgiXG4iKQogICAgICAgIGlmIGV4Y2VwdGlvbnM6CiAgICAgICAgICAgIHNmLndyaXRlKCIqKkV4Y2VwdGlvbiBSaXNrczoqKlxuIikKICAgICAgICAgICAgZm9yIGUgaW4gZXhjZXB0aW9uc1s6M106c2Yud3JpdGUoZiItIOKaoO+4jyBge2V9YFxuIikKICAgICAgICAgICAgc2Yud3JpdGUoIlxuIikKICAgIGlmIHRlY2hfZXhwOgogICAgICAgIHNmLndyaXRlKCIjIyMjIPCfp6AgVGVjaG5pY2FsIEV4cGxhbmF0aW9uXG5cbiIpCiAgICAgICAgc2Yud3JpdGUoZiI+IHt0ZWNoX2V4cFs6NDAwXX1cblxuIikKICAgIGlmIGh1bWFuX2V4cDoKICAgICAgICBzZi53cml0ZSgiIyMjIyDwn5KsIEh1bWFuIEV4cGxhbmF0aW9uXG5cbiIpCiAgICAgICAgc2Yud3JpdGUoZiI+IHtodW1hbl9leHBbOjQwMF19XG5cbiIpCiAgICBpZiByaXNrX3JlYXNvbjoKICAgICAgICBzZi53cml0ZShmIioqUmlzayBSZWFzb25pbmc6Kioge3Jpc2tfcmVhc29uWzozMDBdfVxuXG4iKQogICAgaWYgYmVoYXZfaW1wYWN0OgogICAgICAgIHNmLndyaXRlKGYiKipCZWhhdmlvcmFsIEltcGFjdDoqKiB7YmVoYXZfaW1wYWN0WzozMDBdfVxuXG4iKQogICAgaWYgYmVoYXZpb3JfY2hhbmdlZDoKICAgICAgICBzZi53cml0ZShmIuKaoO+4jyAqKkJlaGF2aW9yIENoYW5nZWQ6Kioge2JlaGF2aW9yX3N1bW1hcnl9XG5cbiIpCiAgICBpZiBzdW1tYXJ5OgogICAgICAgIHNmLndyaXRlKCIjIyMjIPCfk4sgRmluZGluZ3NcblxuIikKICAgICAgICBmb3IgaSxzIGluIGVudW1lcmF0ZShzdW1tYXJ5LDEpOnNmLndyaXRlKGYie2l9LiB7c31cbiIpCiAgICAgICAgc2Yud3JpdGUoIlxuIikKICAgIGlmIHJpc2tfYmQ6CiAgICAgICAgYWN0aXZlPXtrOnYgZm9yIGssdiBpbiByaXNrX2JkLml0ZW1zKCkgaWYgdj4wfQogICAgICAgIGlmIGFjdGl2ZToKICAgICAgICAgICAgc2Yud3JpdGUoIiMjIyMgUmlzayBCcmVha2Rvd25cblxuIikKICAgICAgICAgICAgc2Yud3JpdGUoInwgQ2F0ZWdvcnkgfCBSaXNrIHxcbnwtLS18LS0tfFxuIikKICAgICAgICAgICAgZm9yIGNhdCx2YWwgaW4gYWN0aXZlLml0ZW1zKCk6c2Yud3JpdGUoZiJ8IHtjYXQucmVwbGFjZShjaHIoOTUpLGNocigzMikpLnRpdGxlKCl9IHwge3ZhbH0vMTAwIHxcbiIpCiAgICAgICAgICAgIHNmLndyaXRlKCJcbiIpCiAgICBpZiByZXBvcnRfaWQhPSJOL0EiIGFuZCBhcGlfdXJsOgogICAgICAgIGJhc2U9YXBpX3VybC5yc3RyaXAoIi8iKQogICAgICAgIHNmLndyaXRlKCIjIyMjIPCfk6UgUmVwb3J0IERvd25sb2Fkc1xuXG4iKQogICAgICAgIHNmLndyaXRlKGYiLSBb8J+ThCBKU09OIFJlcG9ydF0oe2Jhc2V9L3JlcG9ydC9qc29uL3tyZXBvcnRfaWR9KVxuIikKICAgICAgICBzZi53cml0ZShmIi0gW/Cfk4ogUERGIFJlcG9ydF0oe2Jhc2V9L3JlcG9ydC9wZGYve3JlcG9ydF9pZH0pXG5cbiIpCiAgICBpZiBhaV9wcm92aWRlciE9Ik4vQSI6c2Yud3JpdGUoZiIqQUkgUHJvdmlkZXI6IHthaV9wcm92aWRlcn0qXG5cbiIpCiAgICBzZi53cml0ZSgiLS0tXG5cbiIpCgpzeXMuZXhpdCgwIGlmIHN0YXR1cz09IlBBU1MiIGVsc2UoMiBpZiBzdGF0dXM9PSJXQVJOIiBlbHNlIDEpKQo=" | base64 -d > "$PARSER"

        for file in $FILES; do
          [ ! -f "$file" ] && continue
          TOTAL=$((TOTAL + 1))
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Analysing: $file"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          OLD_F=$(mktemp); NEW_F=$(mktemp); PAY_F=$(mktemp)
          RES_F=$(mktemp); SCR_F=$(mktemp).py

          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            git show HEAD~1:"$file" > "$OLD_F" 2>/dev/null || true
          fi
          cp "$file" "$NEW_F"

          # Build JSON payload
          printf 'import json\n'                                             > "$SCR_F"
          printf 'o=open("%s").read()\n'                       "$OLD_F"    >> "$SCR_F"
          printf 'n=open("%s").read()\n'                       "$NEW_F"    >> "$SCR_F"
          printf 'p={"old_code":o,"new_code":n,"mode":"%s"}\n' "$MODE"    >> "$SCR_F"
          printf 'open("%s","w").write(json.dumps(p))\n'       "$PAY_F"   >> "$SCR_F"
          python3 "$SCR_F"
          rm -f "$OLD_F" "$NEW_F" "$SCR_F"

          # Call /analyze_full (not /analyze_ci)
          set +e
          HTTP=$(curl -s -w "%{http_code}" -o "$RES_F" \
            -X POST "$API_URL/analyze_full" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --max-time 120 \
            -d "@$PAY_F")
          CE=$?
          set -e
          rm -f "$PAY_F"

          echo "HTTP=$HTTP curl_exit=$CE"
          REPORT="$REPORT_DIR/$(echo "$file" | tr '/' '_').json"

          if [ "$CE" -ne 0 ]; then
            printf '{"status":"FAIL","risk":100,"findings_count":1,"summary":["curl error %s"],"pass":false,"warn":false,"fail":true}\n' "$CE" > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi
          if [ "$HTTP" != "200" ]; then
            printf '{"status":"FAIL","risk":100,"findings_count":1,"summary":["HTTP error %s"],"pass":false,"warn":false,"fail":true}\n' "$HTTP" > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          SZ=$(wc -c < "$RES_F" 2>/dev/null || echo 0)
          if [ "$SZ" -eq 0 ]; then
            echo '{"status":"FAIL","risk":100,"findings_count":1,"summary":["empty response"],"pass":false,"warn":false,"fail":true}' > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          if ! python3 -c "import json,sys; json.load(open('$RES_F'))" 2>/dev/null; then
            echo '{"status":"FAIL","risk":100,"findings_count":1,"summary":["invalid JSON"],"pass":false,"warn":false,"fail":true}' > "$REPORT"
            rm -f "$RES_F"; FAIL_COUNT=$((FAIL_COUNT+1)); continue
          fi

          set +e
          python3 "$PARSER" "$RES_F" "$file" "$REPORT" "$GITHUB_STEP_SUMMARY" "$API_URL"
          PY_EXIT=$?
          set -e
          rm -f "$RES_F"

          if   [ "$PY_EXIT" -eq 0 ]; then PASS_COUNT=$((PASS_COUNT+1))
          elif [ "$PY_EXIT" -eq 2 ]; then WARN_COUNT=$((WARN_COUNT+1))
          else                             FAIL_COUNT=$((FAIL_COUNT+1))
          fi
        done

        rm -f "$PARSER"

        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "Total=$TOTAL  Pass=$PASS_COUNT  Warn=$WARN_COUNT  Fail=$FAIL_COUNT"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

        {
          echo "---"
          echo "## CRONOS v7 â€” Final Summary"
          echo ""
          echo "| Result | Count |"
          echo "|---|---|"
          echo "| âœ… Passed | $PASS_COUNT |"
          echo "| âš ï¸ Warned | $WARN_COUNT |"
          echo "| ðŸ”´ Failed | $FAIL_COUNT |"
          echo "| Total     | $TOTAL |"
        } >> "$GITHUB_STEP_SUMMARY"

        if [ "$FAIL_COUNT" -gt 0 ]; then
          echo "ðŸ”´ BUILD BLOCKED â€” $FAIL_COUNT file(s) failed CRONOS intelligence gate"
          exit 1
        fi
        echo "âœ… BUILD APPROVED â€” all files passed CRONOS intelligence gate"
        exit 0
