    - name: Run CRONOS Analysis
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        MODE: ${{ inputs.mode }}
      run: |
        set -euo pipefail
        API_URL="${API_URL%/}"
        REPORT_DIR="cronos-reports"
        mkdir -p "$REPORT_DIR"

        echo "CRONOS Analysis - Mode=$MODE API=$API_URL"

        if ! curl -sf --max-time 10 "$API_URL/" > /dev/null 2>&1; then
          echo "ERROR: Cannot reach API at $API_URL"
          echo "## âŒ CRONOS: API Unreachable" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        FILES=""
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.py$' || true)
        else
          FILES=$(git ls-files '*.py' || true)
        fi

        if [ -z "$FILES" ]; then
          echo "No Python files changed"
          echo "## âœ… CRONOS: No changes detected" >> "$GITHUB_STEP_SUMMARY"
          exit 0
        fi

        FAIL_COUNT=0
        WARN_COUNT=0
        PASS_COUNT=0
        TOTAL=0

        for file in $FILES; do
          [ ! -f "$file" ] && continue
          TOTAL=$((TOTAL + 1))
          echo "=============================="
          echo "Analyzing: $file"
          echo "=============================="

          OLD=$(git show HEAD~1:"$file" 2>/dev/null || echo "")
          NEW=$(cat "$file")

          PAYLOAD=$(jq -n \
            --arg old "$OLD" \
            --arg new "$NEW" \
            --arg mode "$MODE" \
            '{old_code:$old,new_code:$new,mode:$mode}')

          RESP=$(mktemp)

          HTTP=$(curl -s -w "%{http_code}" \
            -o "$RESP" \
            -X POST "$API_URL/analyze_ci" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            --max-time 60 \
            -d "$PAYLOAD")

          if [ "$HTTP" != "200" ]; then
            echo "HTTP error: $HTTP"
            FAIL_COUNT=$((FAIL_COUNT+1))
            continue
          fi

          if ! jq empty "$RESP" 2>/dev/null; then
            echo "Invalid JSON response"
            FAIL_COUNT=$((FAIL_COUNT+1))
            continue
          fi

          cp "$RESP" "$REPORT_DIR/$(echo $file | tr '/' '_').json"

          STATUS=$(jq -r '.status//"FAIL"' "$RESP")
          RISK=$(jq -r '.risk//100' "$RESP")
          FINDINGS=$(jq -r '.findings_count//0' "$RESP")
          OLD_HASH=$(jq -r '.old_hash//"N/A"' "$RESP")
          NEW_HASH=$(jq -r '.new_hash//"N/A"' "$RESP")
          AST_CHANGED=$(jq -r '.ast_changed//"N/A"' "$RESP")

          echo ""
          echo "------ FULL TECHNICAL RESPONSE ------"
          cat "$RESP"
          echo "-------------------------------------"
          echo ""

          echo "Status=$STATUS Risk=$RISK Findings=$FINDINGS"

          {
            echo "## ðŸ” CRONOS Report â€” $file"
            echo ""
            echo "**Status:** $STATUS"
            echo "**Risk:** $RISK / 100"
            echo "**Findings:** $FINDINGS"
            echo ""
            echo "### ðŸ§  Technical"
            echo "- Old Hash: $OLD_HASH"
            echo "- New Hash: $NEW_HASH"
            echo "- AST Changed: $AST_CHANGED"
            echo ""
            echo "### ðŸ“‹ Summary"
            jq -r '.summary[]?' "$RESP" | sed 's/^/- /'
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          case "$STATUS" in
            PASS) PASS_COUNT=$((PASS_COUNT+1));;
            WARN) WARN_COUNT=$((WARN_COUNT+1));;
            *) FAIL_COUNT=$((FAIL_COUNT+1));;
          esac

          rm -f "$RESP"
        done

        echo "Total=$TOTAL Pass=$PASS_COUNT Warn=$WARN_COUNT Fail=$FAIL_COUNT"

        {
          echo "## ðŸ“Š CRONOS Overall Summary"
          echo "- Passed: $PASS_COUNT"
          echo "- Warned: $WARN_COUNT"
          echo "- Failed: $FAIL_COUNT"
        } >> "$GITHUB_STEP_SUMMARY"

        if [ "$FAIL_COUNT" -gt 0 ]; then
          exit 1
        fi
