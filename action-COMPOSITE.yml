name: 'CRONOS Code Guard'
description: 'CI risk analysis for Python'
author: 'cythonvijay'

inputs:
  api_url:
    description: 'API URL'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Run analysis
      shell: bash
      run: |
        #!/bin/bash
        set -euo pipefail
        
        API_URL="${{ inputs.api_url }}"
        API_URL="${API_URL%/}"
        MODE="STRICT"
        REPORT_DIR="cronos-reports"
        
        echo "ğŸš€ CRONOS Analysis"
        echo "API: $API_URL"
        
        mkdir -p "$REPORT_DIR"
        
        # Test API
        if ! curl -sf --max-time 10 "$API_URL/" > /dev/null; then
            echo "âŒ Cannot reach API"
            exit 1
        fi
        echo "âœ… API reachable"
        
        # Get changed files
        FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '\.py$' || git ls-files '*.py' || true)
        
        if [ -z "$FILES" ]; then
            echo "âœ… No Python files changed"
            exit 0
        fi
        
        echo "Files to analyze:"
        echo "$FILES"
        
        FAIL_COUNT=0
        
        for file in $FILES; do
            [ ! -f "$file" ] && continue
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ $file"
            
            OLD_CODE=$(git show HEAD~1:"$file" 2>/dev/null || echo "")
            NEW_CODE=$(cat "$file")
            
            PAYLOAD=$(jq -n \
                --arg old "$OLD_CODE" \
                --arg new "$NEW_CODE" \
                --arg mode "$MODE" \
                '{"old_code":$old,"new_code":$new,"mode":$mode}')
            
            RESP_FILE="/tmp/resp_$$.json"
            HTTP_CODE=$(curl -s -w "%{http_code}" \
                -o "$RESP_FILE" \
                -X POST "$API_URL/analyze_ci" \
                -H "Content-Type: application/json" \
                -d "$PAYLOAD")
            
            echo "HTTP: $HTTP_CODE"
            
            if [ "$HTTP_CODE" != "200" ]; then
                echo "âŒ API Error"
                FAIL_COUNT=$((FAIL_COUNT + 1))
                continue
            fi
            
            if [ ! -s "$RESP_FILE" ] || ! jq empty "$RESP_FILE" 2>/dev/null; then
                echo "âŒ Invalid response"
                FAIL_COUNT=$((FAIL_COUNT + 1))
                continue
            fi
            
            STATUS=$(jq -r '.status // "FAIL"' "$RESP_FILE")
            RISK=$(jq -r '.risk // 100' "$RESP_FILE")
            
            cp "$RESP_FILE" "$REPORT_DIR/${file//\//_}.json"
            
            echo "Status: $STATUS (Risk: $RISK)"
            
            if [ "$STATUS" == "FAIL" ]; then
                FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
        done
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ $FAIL_COUNT -gt 0 ]; then
            echo "ğŸš« BUILD BLOCKED ($FAIL_COUNT failed)"
            exit 1
        else
            echo "âœ… BUILD APPROVED"
            exit 0
        fi
