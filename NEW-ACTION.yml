name: 'CRONOS Code Guard'
description: 'Static analysis for Python code changes with risk assessment'
author: 'cythonvijay'
branding:
  icon: 'shield'
  color: 'blue'

inputs:
  api_url:
    description: 'CRONOS API endpoint URL'
    required: true
  mode:
    description: 'Analysis mode: STRICT, BOUNDARY, or CONTRACT'
    required: false
    default: 'STRICT'

runs:
  using: 'composite'
  steps:

    - name: Install dependencies
      shell: bash
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update -qq
          sudo apt-get install -y jq curl
        fi

    - name: Run CRONOS Analysis
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        MODE: ${{ inputs.mode }}
      run: |
        set +e   # <-- IMPORTANT: prevents pipeline crash

        API_URL="${API_URL%/}"
        REPORT_DIR="cronos-reports"
        mkdir -p "$REPORT_DIR"

        echo "==============================="
        echo "ðŸš€ Running CRONOS Analysis"
        echo "API: $API_URL"
        echo "Mode: $MODE"
        echo "==============================="

        echo "ðŸ”Œ Checking API..."
        if ! curl -sf --max-time 10 "$API_URL/" > /dev/null 2>&1; then
          echo "âŒ Cannot reach API at $API_URL"
          exit 1
        fi
        echo "âœ… API reachable"

        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.py$' || true)
        else
          FILES=$(git ls-files '*.py' || true)
        fi

        if [ -z "$FILES" ]; then
          echo "âœ… No Python files changed â€” skipping."
          exit 0
        fi

        FAIL_COUNT=0
        TOTAL=0

        echo "## ðŸ” CRONOS Analysis Report" >> "$GITHUB_STEP_SUMMARY"

        for file in $FILES; do
          TOTAL=$((TOTAL + 1))
          echo "ðŸ“„ Analyzing: $file"

          OLD_CODE=""
          git show HEAD~1:"$file" 2>/dev/null || true

          NEW_CODE=$(cat "$file")

          PAYLOAD=$(jq -n \
            --arg old "$OLD_CODE" \
            --arg new "$NEW_CODE" \
            --arg mode "$MODE" \
            '{old_code:$old, new_code:$new, mode:$mode}')

          RESP_FILE="$REPORT_DIR/${file//\//_}.json"

          HTTP_CODE=$(curl -s -w "%{http_code}" \
            -o "$RESP_FILE" \
            -X POST "$API_URL/analyze_ci" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "HTTP: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo '{"status":"FAIL","risk":100,"error":"HTTP_ERROR"}' > "$RESP_FILE"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            continue
          fi

          if [ ! -s "$RESP_FILE" ] || ! jq empty "$RESP_FILE" 2>/dev/null; then
            echo '{"status":"FAIL","risk":100,"error":"INVALID_JSON"}' > "$RESP_FILE"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            continue
          fi

          STATUS=$(jq -r '.status' "$RESP_FILE")
          RISK=$(jq -r '.risk' "$RESP_FILE")
          SUMMARY=$(jq -r '.summary[]?' "$RESP_FILE" 2>/dev/null || echo "No issues detected")

          echo "::notice::CRONOS â†’ $file | Status=$STATUS | Risk=$RISK"

          {
            echo "### File: \`$file\`"
            echo "**Status:** $STATUS"
            echo "**Risk:** $RISK / 100"
            echo "**Findings:**"
            echo "$SUMMARY" | sed 's/^/- /'
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$STATUS" = "FAIL" ]; then
            FAIL_COUNT=$((FAIL_COUNT + 1))
          fi
        done

        echo "==============================="
        echo "FINAL RESULT"
        echo "Files checked: $TOTAL"
        echo "Failures: $FAIL_COUNT"
        echo "==============================="

        if [ $FAIL_COUNT -gt 0 ]; then
          echo "ðŸš« Build blocked due to CRONOS risk."
          exit 1
        else
          echo "âœ… Build approved."
          exit 0
        fi
